<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIT-Inspired Mechatronics Course (G7-G12)</title>
    <!-- Load Tailwind CSS for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for aesthetic appeal and responsiveness */
        :root {
            --primary-color: #f6993f; /* Orange/Gold for MIT feel */
            --secondary-color: #38a169; /* Green for success/pass */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .container {
            max-width: 1000px;
        }
        .course-card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-left: 6px solid var(--primary-color);
            transition: transform 0.2s;
        }
        .unlocked-card:hover {
            transform: translateY(-3px);
            cursor: pointer;
        }
        .pass-button {
            background-color: var(--secondary-color);
            transition: background-color 0.2s;
        }
        .pass-button:hover:not(:disabled) {
            background-color: #2f855a;
        }
        .locked-unit {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .flag-button {
            transition: transform 0.1s;
        }
        .flag-button:hover {
            transform: scale(1.1);
        }
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-top: 1.5rem;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="container mx-auto">
        <!-- HEADER AND LANGUAGE SELECTION -->
        <header class="text-center mb-10 p-6 bg-white rounded-xl shadow-lg">
            <h1 class="text-4xl font-extrabold text-gray-800">Mechatronics: G7 Foundations</h1>
            <p class="text-lg text-gray-500 mt-2">Prepared for MIT Faculty (G7-G12 Curriculum)</p>
            <div class="mt-4 flex justify-center space-x-4">
                <button onclick="setLanguage('en')" class="flag-button p-2 rounded-full border border-gray-300 bg-white shadow-sm" title="English">
                    <span class="text-2xl">🇺🇸</span>
                </button>
                <button onclick="setLanguage('th')" class="flag-button p-2 rounded-full border border-gray-300 bg-white shadow-sm" title="Thai">
                    <span class="text-2xl">🇹🇭</span>
                </button>
                <button onclick="setLanguage('zh')" class="flag-button p-2 rounded-full border border-gray-300 bg-white shadow-sm" title="Mandarin">
                    <span class="text-2xl">🇹🇼</span>
                </button>
            </div>
            <p id="language-display" class="text-sm text-gray-500 mt-2">Language: English</p>
            <p id="auth-status" class="text-xs text-blue-600 mt-1"></p>
        </header>
        
        <!-- MAIN CONTENT AREA -->
        <div id="content" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- COURSE DASHBOARD (LEFT) -->
            <div class="lg:col-span-1 space-y-4">
                <h2 id="dashboard-title" class="text-2xl font-semibold text-gray-700">Course Units</h2>
                <div id="unit-list" class="space-y-3">
                    <!-- Unit cards will be rendered here by JavaScript -->
                </div>
            </div>

            <!-- LECTURE / QUIZ AREA (RIGHT) -->
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg min-h-[500px]">
                <div id="current-unit-display">
                    <h2 class="text-3xl font-bold text-gray-800 border-b pb-3 mb-4" id="unit-title">Select a Unit to Begin</h2>
                    <div id="lecture-content" class="text-gray-700 space-y-4">
                        <p id="lecture-text">Welcome! Your progress is saved automatically. Select G7 Unit 1 to start your Mechatronics journey from the very basics, scaled up to MIT's standards of rigor.</p>
                         <div id="video-container" class="video-container hidden"></div>
                    </div>
                    
                    <!-- IN-APP QUIZ SECTION (The 100% Gate) -->
                    <div id="quiz-area" class="mt-8 p-6 bg-gray-50 rounded-lg hidden">
                        <h3 id="quiz-header" class="text-2xl font-semibold text-gray-800 mb-4">Unit Quiz: Pass 100% to Unlock Next Unit</h3>
                        <div id="quiz-questions" class="space-y-6">
                            <!-- Questions rendered here -->
                        </div>
                        <button id="submit-quiz-btn" onclick="submitQuiz()" class="pass-button text-white font-bold py-3 px-6 rounded-lg mt-6 shadow-md w-full">
                            Submit Quiz
                        </button>
                        <p id="quiz-feedback" class="mt-4 text-center font-bold"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FIREBASE AND CORE SCRIPTS -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL VARIABLES ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db;
        let auth;
        let userId = null;
        let activeUnitId = 'G7_U1';
        let userProgress = { scores: {}, current_unit: 'G7_U1' };
        let currentLanguage = 'en';

        // --- CURRICULUM DATA ---
        const CURRICULUM = {
            'G7_U1': {
                title: { en: "G7 Unit 1: Simple Machines & Force Transfer", th: "G7 หน่วยที่ 1: เครื่องจักรกลอย่างง่ายและการถ่ายโอนแรง", zh: "七年级第一单元：简单机械与力传递"},
                lecture: { en: "This unit is the foundation of Mechanical Systems...", th: "หน่วยนี้คือรากฐานของระบบกลไก...", zh: "本单元是机械系统的基础..."},
                youtube: "https://www.youtube.com/embed/fvOmaf2GfCY",
                quiz: [
                    { question: { en: "Which simple machine multiplies force...?", th: "เครื่องจักรกลอย่างง่ายใดที่ช่วยเพิ่มแรง...?", zh: "哪种简单机械可以增大作用力...?" }, options: { en: ["Pulley", "Gear", "Lever"], th: ["รอก", "เฟือง", "คาน"], zh: ["滑轮", "齿轮", "杠杆"]}, answer: 2 },
                    { question: { en: "What is the primary role of a gear system...?", th: "บทบาทหลักของระบบเฟือง...?", zh: "齿轮系统在机电一体化中的主要作用...?" }, options: { en: ["Generate electricity", "Store data", "Transfer and change speed/torque"], th: ["ผลิตไฟฟ้า", "จัดเก็บข้อมูล", "ถ่ายโอนและเปลี่ยนความเร็ว/แรงบิด"], zh: ["发电", "储存数据", "传输和改变速度/扭矩"]}, answer: 2 }
                ],
                next_unit: 'G7_U2'
            },
            'G7_U2': {
                title: { en: "G7 Unit 2: Basic Circuits & Components", th: "G7 หน่วยที่ 2: วงจรพื้นฐานและส่วนประกอบ", zh: "七年级第二单元：基础电路与元件"},
                lecture: { en: "In this unit, we introduce the flow of energy...", th: "ในหน่วยนี้ เราจะแนะนำการไหลของพลังงาน...", zh: "在本单元中，我们介绍能量的流动..."},
                youtube: "https://www.youtube.com/embed/vYpolxA12-Y",
                quiz: [
                    { question: { en: "What component limits the flow of current...?", th: "ส่วนประกอบใดจำกัดการไหลของกระแสไฟฟ้า...?", zh: "哪个元件用于限制电路中的电流...?" }, options: { en: ["LED", "Resistor", "Switch"], th: ["LED", "ตัวต้านทาน", "สวิตช์"], zh: ["LED", "电阻", "开关"]}, answer: 1 },
                    { question: { en: "What is the unit of measure for electrical resistance?", th: "หน่วยวัดความต้านทานไฟฟ้าคืออะไร?", zh: "电阻 की หน่วยวัดคืออะไร?" }, options: { en: ["Volt", "Ohm", "Ampere"], th: ["โวลต์", "โอห์ม", "แอมแปร์"], zh: ["伏特", "欧姆", "安培"]}, answer: 1 }
                ],
                next_unit: 'G7_U3'
            },
            'G7_U3': {
                title: { en: "G7 Unit 3: Block-Based Coding Logic", th: "G7 หน่วยที่ 3: ตรรกะการเขียนโค้ดแบบบล็อก", zh: "七年级第三单元：积木式编程逻辑"},
                lecture: { en: "The final pillar: Control...", th: "เสาหลักสุดท้าย: การควบคุม...", zh: "最后一根支柱：控制..."},
                youtube: "https://www.youtube.com/embed/hsHsq433T-o",
                quiz: [
                    { question: { en: "What is the primary function of an 'IF/THEN' block?", th: "หน้าที่หลักของบล็อก 'IF/THEN' คืออะไร?", zh: "‘IF/THEN’ 模块的主要功能是什么？" }, options: { en: ["Repeating a task", "Making a decision", "Storing a value"], th: ["ทำซ้ำงาน", "ตัดสินใจ", "จัดเก็บค่า"], zh: ["重复任务", "做出决定", "存储数值"]}, answer: 1 },
                    { question: { en: "Which concept involves running a sequence of code steps one after the other?", th: "แนวคิดใดที่เกี่ยวข้องกับการรันขั้นตอนโค้ดตามลำดับทีละขั้นตอน?", zh: "哪个概念涉及按顺序运行一系列代码步骤？" }, options: { en: ["Looping", "Debugging", "Sequencing"], th: ["การวนซ้ำ", "การแก้ไขจุดบกพร่อง", "การเรียงลำดับ"], zh: ["循环", "调试", "序列"]}, answer: 2 }
                ],
                next_unit: 'G8_U1'
            },
             'G8_U1': {
                title: { en: "G8 Unit 1: Introduction to Microcontrollers (MCU)", th: "G8 หน่วยที่ 1: บทนำสู่ไมโครคอนโทรลเลอร์ (MCU)", zh: "八年级第一单元：微控制器 (MCU) 入门"},
                lecture: { en: "Congratulations on completing G7! G8 focuses on the **Microcontroller (MCU)**...", th: "ขอแสดงความยินดีที่เรียน G7 จบ! G8 เน้นที่ **ไมโครคอนโทรลเลอร์ (MCU)**...", zh: "恭喜您完成七年级！八年级重点学习**微控制器（MCU）**..."},
                youtube: "https://www.youtube.com/embed/j_sD_o4Y_d8",
                quiz: [
                    { question: { en: "What is the primary function of the Microcontroller in a mechatronics system?", th: "หน้าที่หลักของไมโครคอนโทรลเลอร์ในระบบเมคคาทรอนิกส์คืออะไร?", zh: "微控制器在机电一体化系统中的主要功能是什么？" }, options: { en: ["Storage of large files", "Processing logic and control signals", "Providing power to motors"], th: ["จัดเก็บไฟล์ขนาดใหญ่", "ประมวลผลตรรกะและสัญญาณควบคุม", "จ่ายพลังงานให้กับมอเตอร์"], zh: ["存储大型文件", "处理逻辑和控制信号", "为电机供电"]}, answer: 1 },
                    { question: { en: "When programming an Arduino MCU, what does 'Digital Output' typically refer to?", th: "เมื่อเขียนโปรแกรม Arduino MCU, 'เอาต์พุตดิจิทัล' โดยทั่วไปหมายถึงอะไร?", zh: "编程 Arduino MCU 时，'数字输出'通常指什么？" }, options: { en: ["Reading a sensor value", "Turning a component ON or OFF (HIGH/LOW)", "Translating the language"], th: ["การอ่านค่าเซ็นเซอร์", "การเปิดหรือปิดส่วนประกอบ (HIGH/LOW)", "การแปลภาษา"], zh: ["读取传感器值", "打开或关闭组件（HIGH/LOW）", "翻译语言"]}, answer: 1 }
                ],
                next_unit: 'G8_U2'
            },
        };
        const ALL_UNITS = Object.keys(CURRICULUM);

        // --- FIREBASE INITIALIZATION ---
        async function initFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing. Using local fallback.");
                    userId = 'localuser_' + Date.now();
                    document.getElementById('auth-status').textContent = `Status: Local Mode`;
                    loadLocalProgress();
                    return;
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, user => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('auth-status').textContent = `Status: Logged In (ID: ${userId.substring(0,8)}...)`;
                        setupProgressListener();
                    } else {
                        signInAnonymously(auth).catch(err => console.error("Anonymous sign-in failed:", err));
                    }
                });
            } catch (error) {
                console.error("Firebase init failed:", error);
                document.getElementById('auth-status').textContent = `Error: Cannot connect to Firebase.`;
            }
        }

        // --- PROGRESS HANDLING ---
        function getProgressDocRef() {
            return doc(db, `artifacts/${appId}/users/${userId}/progress/mechatronics_state`);
        }

        function setupProgressListener() {
            if (!db || !userId) return;
            onSnapshot(getProgressDocRef(), (docSnap) => {
                if (docSnap.exists()) {
                    userProgress = { scores: {}, ...docSnap.data() };
                    if (!userProgress.scores) userProgress.scores = {};
                } else {
                    userProgress = { current_unit: 'G7_U1', scores: {} };
                    setDoc(getProgressDocRef(), userProgress);
                }
                activeUnitId = userProgress.current_unit || 'G7_U1';
                renderDashboard();
                loadUnit(activeUnitId);
            }, error => console.error("Progress listener failed:", error));
        }

        async function saveProgress(unitId, score) {
            const nextUnit = CURRICULUM[unitId]?.next_unit || unitId;
            const newProgress = {
                scores: { ...userProgress.scores, [unitId]: score },
                current_unit: nextUnit
            };
            if (db && userId) {
                try {
                    await runTransaction(db, async (transaction) => {
                        transaction.set(getProgressDocRef(), newProgress, { merge: true });
                    });
                    console.log("Transaction successfully committed!");
                } catch (e) {
                    console.error("Transaction failed: ", e);
                }
            } else {
                localStorage.setItem('mechatronicsProgress', JSON.stringify(newProgress));
                userProgress = newProgress;
            }
        }
        
        function loadLocalProgress() {
            const stored = localStorage.getItem('mechatronicsProgress');
            if (stored) {
                userProgress = JSON.parse(stored);
                 if (!userProgress.scores) userProgress.scores = {};
            } else {
                userProgress = { current_unit: 'G7_U1', scores: {} };
            }
            activeUnitId = userProgress.current_unit || 'G7_U1';
            renderDashboard();
            loadUnit(activeUnitId);
        }

        // --- UI RENDERING ---
        window.setLanguage = (lang) => {
            currentLanguage = lang;
            document.getElementById('language-display').textContent = `Language: ${lang.toUpperCase()}`;
            renderDashboard();
            loadUnit(activeUnitId);
        };

        function renderDashboard() {
            const unitListDiv = document.getElementById('unit-list');
            unitListDiv.innerHTML = '';
            let unlocked = true;
            ALL_UNITS.forEach(unitId => {
                const unitData = CURRICULUM[unitId];
                const isPassed = userProgress.scores[unitId] === 100;
                const isLocked = !unlocked;
                const title = unitData.title[currentLanguage] || unitData.title['en'];
                const card = document.createElement('div');
                card.className = `course-card p-4 rounded-lg flex items-center justify-between ${isLocked ? 'locked-unit bg-gray-100' : 'unlocked-card bg-white hover:bg-gray-50'}`;
                card.innerHTML = `<div><p class="text-sm font-medium ${isPassed ? 'text-secondary-color' : 'text-gray-700'}">${title}</p><p class="text-xs text-gray-400">${isLocked ? 'Locked' : 'Click to View'}</p></div><span class="text-2xl">${isPassed ? '✅' : (isLocked ? '🔒' : '▶️')}</span>`;
                if (!isLocked) card.onclick = () => loadUnit(unitId);
                unitListDiv.appendChild(card);
if (!isPassed) unlocked = false;
            });
        }

        window.loadUnit = (unitId) => {
            activeUnitId = unitId;
            const unitData = CURRICULUM[unitId];
            if (!unitData) {
                document.getElementById('unit-title').textContent = "Congratulations!";
                document.getElementById('lecture-text').innerHTML = "<p>You have completed all available units. Well done!</p>";
                document.getElementById('video-container').classList.add('hidden');
                document.getElementById('quiz-area').classList.add('hidden');
                return;
            };
            const isPassed = userProgress.scores[unitId] === 100;
            const title = unitData.title[currentLanguage] || unitData.title['en'];
            const lecture = unitData.lecture[currentLanguage] || unitData.lecture['en'];
            
            document.getElementById('unit-title').textContent = title;
            document.getElementById('lecture-text').innerHTML = lecture;

            const videoContainer = document.getElementById('video-container');
            if (unitData.youtube) {
                videoContainer.innerHTML = `<iframe src="${unitData.youtube}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
                videoContainer.classList.remove('hidden');
            } else {
                videoContainer.classList.add('hidden');
            }

            if (unitId === userProgress.current_unit && !isPassed) {
                renderQuiz(unitData.quiz);
            } else {
                document.getElementById('quiz-area').classList.add('hidden');
                if (isPassed) {
                    document.getElementById('lecture-text').innerHTML += `<p class="mt-4 text-center text-xl font-bold text-secondary-color">✅ UNIT COMPLETE!</p>`;
                }
            }
        };
        
        function renderQuiz(questions) {
            const quizQuestionsDiv = document.getElementById('quiz-questions');
            quizQuestionsDiv.innerHTML = '';
            if (!questions) return;
            questions.forEach((q, i) => {
                const qDiv = document.createElement('div');
                qDiv.className = 'border p-4 rounded-lg bg-white';
                const qText = q.question[currentLanguage] || q.question['en'];
                qDiv.innerHTML = `<p class="font-semibold mb-3 text-lg">${i + 1}. ${qText}</p>`;
                const options = q.options[currentLanguage] || q.options['en'];
                options.forEach((opt, j) => {
                    qDiv.innerHTML += `<label class="block mt-2 cursor-pointer hover:bg-gray-100 p-2 rounded"><input type="radio" name="q${i}" value="${j}" class="mr-2 accent-primary-color"> ${opt}</label>`;
                });
                quizQuestionsDiv.appendChild(qDiv);
            });
            document.getElementById('quiz-area').classList.remove('hidden');
            document.getElementById('quiz-feedback').textContent = '';
            document.getElementById('submit-quiz-btn').disabled = false;
        }

        window.submitQuiz = async () => {
            const questions = CURRICULUM[activeUnitId].quiz;
            let correct = 0;
            questions.forEach((q, i) => {
                const selected = document.querySelector(`input[name="q${i}"]:checked`);
                if (selected && parseInt(selected.value) === q.answer) correct++;
            });

            const feedback = document.getElementById('quiz-feedback');
            if (correct === questions.length) {
                feedback.className = 'mt-4 text-center text-xl font-bold text-secondary-color';
                feedback.textContent = `PERFECT! 100% PASSED. Unlocking next unit...`;
                document.getElementById('submit-quiz-btn').disabled = true;
                
                await saveProgress(activeUnitId, 100);

                // The listener will auto-reload the view. We just need to load the next unit.
                const nextUnitId = CURRICULUM[activeUnitId].next_unit;
                if(nextUnitId) {
                   setTimeout(() => loadUnit(nextUnitId), 1500);
                } else {
                   setTimeout(() => loadUnit(null), 1500); // End of course
                }

            } else {
                feedback.className = 'mt-4 text-center text-xl font-bold text-red-600';
                feedback.textContent = `INCORRECT. (${correct}/${questions.length}). You must achieve 100% to proceed.`;
            }
        };

        // Initialize the app
        initFirebase();
        renderDashboard();
    </script>
</body>
</html>